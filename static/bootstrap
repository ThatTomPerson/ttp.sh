#!/usr/bin/env bash

# set colors
ORANGE="\033[1;33m"
BLUE="\033[1;34m"
RESET="\033[m"


function warn() {
  printf "${ORANGE}WARN: ${1}${RESET}\n"
}
function info() {
  printf "${BLUE}INFO: ${1}${RESET}\n"
}

function installzip() {
  set -x
  tempd=$(mktemp -d)
  curl -L $1 > $tempd/pkg.zip
  unzip $tempd/pkg.zip -d $tempd/
  sudo cp -rf $tempd/*.app /Applications
  rm -rf $tempd
  set +x
}

function installdmg() {
  set -x
  tempd=$(mktemp -d)
  curl -L $1 > $tempd/pkg.dmg
  listing=$(sudo hdiutil attach $tempd/pkg.dmg | grep Volumes)
  volume=$(echo "$listing" | cut -f 3)
  if [ -e "$volume"/*.app ]; then
    sudo cp -rf "$volume"/*.app /Applications
  elif [ -e "$volume"/*.pkg ]; then
    package=$(ls -1 | grep *.pkg | head -1)
    sudo installer -pkg "$volume"/"$package".pkg -target /
  fi
  sudo hdiutil detach "$(echo "$listing" | cut -f 1)"
  rm -rf $tempd
  set +x
}


info "Bootstrapping a new macOS"
info "sudo password may be required"
info "cntr-c now to cancel"

sleep 5

info "Installing Homebrew"
/usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"

info "Installing Extra Fonts"
brew tap caskroom/fonts
brew cask install font-fira-code

info "Install Common Brew tools"
brew install dep go hugo dnsmasq thattomperson/tap/remote thattomperson/tap/vm

info "Setting Up DNS for .test domains"
# Copied from https://gist.github.com/ogrrd/5831371 and https://github.com/Homebrew/homebrew-services
mkdir -pv $(brew --prefix)/etc/
echo 'address=/.test/127.0.0.1' > $(brew --prefix)/etc/dnsmasq.conf
sudo mkdir -v /etc/resolver
sudo bash -c 'echo "nameserver 127.0.0.1" > /etc/resolver/test'


info "Starting dnsmasq now (and starting on boot)"
sudo brew services start dnsmasq

info "Starting vm now (and starting on login)"
brew services start vm

mkdir -p ~/Projects/example
curl -L ttp.sh/example/index.html > Projects/example/index.html
curl -L ttp.sh/example/docker-compose.yml > Projects/example/docker-compose.yml
(cd Projects/example; vm start)
info "vm is running, goto https://example.test to have a look"

info "Downloading Visual Studio Code"
installzip https://go.microsoft.com/fwlink/?LinkID=620882

info "SUCCESS! Enjoy your new Mac"
exit 0